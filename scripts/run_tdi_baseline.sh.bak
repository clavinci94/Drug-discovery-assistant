#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$ROOT"
export PYTHONPATH="."

# festes Target & UniProt f√ºr VEGFR2/KDR
TID="CHEMBL279"             # VEGFR2/KDR
UNIPROT_QUERY="accession:P35968"
LIMIT="${1:-600}"

echo "‚úÖ Nutze festes Target: VEGFR2/KDR (${TID})"

echo "‚û°Ô∏è  Baue Molek√ºl-Dataset (limit=${LIMIT})‚Ä¶"
python -m src.data.processors.prepare_dataset --target "${TID}" --limit "${LIMIT}"

echo "‚û°Ô∏è  Erzeuge Protein-Embedding (UniProt VEGFR2: P35968)‚Ä¶"
ACC_AND_PATH=$(python - << PY
from src.features.protein.embed_and_save import embed_uniprot_and_save
acc, path = embed_uniprot_and_save("${UNIPROT_QUERY}")
print(acc + "|" + path)
PY
)
ACC="${ACC_AND_PATH%|*}"
PEMB="${ACC_AND_PATH#*|}"
echo "‚úÖ UniProt: ${ACC} | Embedding: ${PEMB}"

echo "‚û°Ô∏è  Trainiere TDI-MLP‚Ä¶"
python -m src.models.tdi_mlp --protein_emb "${PEMB}" --epochs 10 --lr 1e-3 --batch_size 256

echo "üéâ Fertig. Artefakte: models/tdi_mlp.pt , models/tdi_mlp_metrics.json"
